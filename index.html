<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="">

		<title>Safe Tube - Video Gallery</title>

		<!-- Bootstrap core CSS -->
		<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

		<!-- Custom styles for this template -->
		<link href="css/thumbnail-gallery.css" rel="stylesheet">

	</head>

	<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
		<div class="container">
			<a class="navbar-brand" href="#"><img src="content/1a.jpg" width="10%"></a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarResponsive">
				<input type="file" id="vfile" name="vfile"/>
			</div>
			<!--
			<div class="collapse navbar-collapse" id="navbarResponsive">
			<ul class="navbar-nav ml-auto">
			<li class="nav-item active">
			<a class="nav-link" href="#">Home
			<span class="sr-only">(current)</span>
			</a>
			</li>
			<li class="nav-item">
			<a class="nav-link" href="#">About</a>
			</li>
			<li class="nav-item">
			<a class="nav-link" href="#">Services</a>
			</li>
			<li class="nav-item">
			<a class="nav-link" href="#">Contact</a>
			</li>
			</ul>
			</div>-->
		</div>
    </nav>

		<!-- Page Content -->
		<div class="container">
			<h4 class="my-4 text-center text-lg-left">safeMutableData Gallery</h4>
			<div id="imgDiv" class="row text-center text-lg-left">
				<!--
				<div class="col-lg-3 col-md-4 col-xs-6">
					<a href="#" class="d-block mb-4 h-100">
						<img class="img-fluid img-thumbnail" src="http://placehold.it/400x300" alt="">
					</a>
				</div>
				-->
			</div>
		</div>
		<!-- /.container -->

		<!-- Footer -->
		<footer class="py-5 bg-dark">
			<div class="container">
				<p class="m-0 text-center text-white">BABY Safe</p>
			</div>
			<!-- /.container -->
		</footer>

		<!-- Bootstrap core JavaScript -->
		<script src="vendor/jquery/jquery.min.js"></script>
		<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script type="text/javascript">
			function authorise(){
				var app = {
					name = 'safetube-vijay',
					id = 'safetube-vijay',
					version = '1.0',
					vendor = 'SafeTube.Vijay',
				};
				
				var privileges = {
					'_public' : [
						'Read',
						'Insert',
						'Update',
						'Delete',
						'ManagePermissions',
					],
					'_publicNames' : [
						'Read',
						'Insert',
						'Update',
						'Delete',
						'ManagePermissions'
					]
				};
				
				var container = {
					safetube_vijay_container: true
				};
				
				window.safeApp.initialise(app)
					.then((appToken) => {
						//Tracking
						console.log('Initialising Token - ' + appToken );
						window.safeApp.authorise(appToken, privileges, container)
							.then((auth) => {
								window.safeApp.connectAuthorised(appToken, auth)
									.then((authorisedAppToken) => {
										window.auth = authorisedAppToken;
										//Tracking
										console.log('Authorised App Token ' + authorisedAppToken );
										listVideos();
									});
							});
					
					},
					(err) => {
						console.error('Error Authorisation' + err);
					});
			}
					
			function listVideos(){
				var _container = 'vijay/safetube-container';
				
				window.safeApp.getContainer(auth, _container)
					.then((mdHandle) => {
						//Tracking
						console.log('Handle ' + mdHandle);
						window.safeMutableData.getEntries(mdHandle)
							.then((entries) => {
								window.safeMutableDataEntries.forEach(entries, (key, value) => {
									//Tracking
									console.log('File found ' + new TextDecoder("utf-8").decode(key));
									document.getElementById('imgDiv').innerHTML += '<div class="col-lg-3 col-md-4 col-xs-6"><a href="#" class="d-block mb-4 h-100"><video class="img-fluid img-thumbnail video-js" controls> <source src="data:video/' + (new TextDecoder("utf-8").decode(key)).split('.').pop() + ';base64,' + arrayBufferToBase64(value.buf) + '" type="video/' + (new TextDecoder("utf-8").decode(key)).split('.').pop() + '"></video></a></div>';
								});
							});
					},
					(err) => {
						console.error('Error lising videos' + err);
					});
			}
			
			function arrayBufferToBase64(_buffer) {
				var _binary = '';
				var _bytes = new Uint8Aray(_buffer);
				var _len = _bytes.byteLength;
				
				for (var inc  = 0; inc < _len; inc++) {
					_bytes += String.fromCharCode(_bytes[inc]);
				}
				
				return _bytes.buffer;
			}
			
			function uploadVideo() {
				var container = 'vijay/safetube-container';
				
				var _file = document.getElementById("vfile");
				var _reader = new FileReader();
				
				var _content = null;
				
				_reader.readAsArrayBuffer(new Blob([_file.files[0]]));
				_reader.onload = function(_event) {
					var arrayBuffer = _reader.result;
					_content = new Uint8Aray(arrayBuffer);
					return _content;
				};
				
				window.safeApp.getContainer(auth, container)
					.then((mdHandle) => {
						window.safeMutableData.newMutation(auth)
							.then((mutationHandle) => 
								window.safeMutableDataMutation.insert(mutationHandle, file.files[0].name, _content).then() =>
									window.safeMutableData.applyEntriesMutation(mdHandle, mutationHandle)).then(() =>
										//Tracking
										console.log('New entry committed to the network');
									)
					},
					(err) => {
						//Error Tracking
						console.error('Error uploading video ' + err);
					});
			}
		</script>
	</body>
</html>
